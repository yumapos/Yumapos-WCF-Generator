//------------------------------------------------------------------------------
// <auto-generated>
//     This code was generated from a template.
//
//     Manual changes to this file may cause unexpected behavior in your application.
//     Manual changes to this file will be overwritten if the code is regenerated.
// </auto-generated>
//------------------------------------------------------------------------------

using System;
using System.ServiceModel;

namespace TestWcfClientGenerator
{
	 public sealed class FlowOperationContextScope : IDisposable
	 { 
		 private bool _inFlight; 
		 private bool _disposed; 
		 private OperationContext _thisContext; 
		 private OperationContext _originalContext; 

		 public FlowOperationContextScope(IContextChannel channel)
 			: this(new OperationContext(channel)) {} 

		 public FlowOperationContextScope(OperationContext context)
 		 { 
 			 _originalContext = OperationContext.Current; 
			 _thisContext = context;
			 OperationContext.Current = context;
			 while (OperationContext.Current == null) 
			 {
				 OperationContext.Current = context;
			 }
		}

		 public void Dispose()
 		 { 
 			 if (_disposed) return; 
			 if (_inFlight || OperationContext.Current != _thisContext)
 			 { 
 				 throw new InvalidOperationException();
 			 } 
			 _disposed = true; 
			 OperationContext.Current = _originalContext; 
			 _thisContext = null; 
			 _originalContext = null; 
 		 } 

		 internal void BeforeAwait() 
		 { 
			 if (_inFlight) 
			 { 
 				 return; 
 			 } 
			 _inFlight = true; 
		 } 

		 internal void AfterAwait() 
		 { 
			 if (!_inFlight) 
			 { 
 				 throw new InvalidOperationException(); 
 			 } 
 			 _inFlight = false; 
			 OperationContext.Current = _thisContext; 
		 } 
 	 } 
 }